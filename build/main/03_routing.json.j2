{% set region = {
    'zh': 'cn',
    'cn': 'cn',
    'ir': 'ir',
    'ru': 'ru'
}.get(hconfigs['country'], 'cn') %}

{% set geo_sites=[
  'spotify','google','netflix',
  'nvidia','bytedance','tiktok','unity',
  'reddit','openai'
] %}

{% set warp_sites = hconfigs.get('warp_sites','').split('\n') %}

{
  "route": {
    "rule_set": [
      {
        "tag": "geoip-{{region}}",
        "type": "remote",
        "format": "binary",
        "update_interval": "1d",
        "url": "https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geoip-{{region}}.srs"
      },
      {
        "tag": "geosite-{{region}}",
        "type": "remote",
        "format": "binary",
        "update_interval": "1d",
        "url": "https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-{{region}}.srs"
      },
      {% for site in geo_sites %}
      {
        "tag": "geosite-{{site}}",
        "type": "remote",
        "format": "binary",
        "update_interval": "1d",
        "url": "https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/sing/geo/geosite/{{site}}.srs"
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ],

    "final": {% if hconfigs['warp_mode'] == 'all' %}"WARP"{% else %}"freedom"{% endif %},

    "rules": [
      {
        "protocol": "quic",
        "port": [443],
        "outbound": "blackhole"
      },

      {
        "outbound": {% if hconfigs['warp_mode'] == 'disable' %}"forbidden_sites"{% else %}"WARP"{% endif %},
        "rule_set": [
          "geoip-{{region}}",
          "geosite-{{region}}"
        ]
      },

      {% if hconfigs['warp_mode'] != 'disable' %}
      {
        "outbound": "WARP",
        "rule_set": [
          {% for site in geo_sites %}
          "geosite-{{site}}"{% if not loop.last %},{% endif %}
          {% endfor %}
        ]
      },
      {% endif %}

      {% if hconfigs['warp_mode'] != 'disable' and warp_sites %}
      {
        "outbound": "WARP",
        "domain": [
          {% for d in warp_sites if d.strip() %}
          "{{ d.strip() }}"{% if not loop.last %},{% endif %}
          {% endfor %}
        ]
      },
      {% endif %}

      {
        "ip_cidr": [
          "0.0.0.0/8",
          "10.0.0.0/8",
          "100.64.0.0/10",
          "127.0.0.0/8",
          "169.254.0.0/16",
          "172.16.0.0/12",
          "192.0.0.0/24",
          "192.168.0.0/16",
          "198.18.0.0/15",
          "224.0.0.0/4",
          "240.0.0.0/4"
        ],
        "outbound": "blackhole"
      },

      {
        "protocol": ["bittorrent"],
        "outbound": "blackhole"
      }
    ]
  }
}
