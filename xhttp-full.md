# گزارش فنی جامع XHTTP: Beyond REALITY

## مقدمه

XHTTP یک پروتکل انتقال (Transport Protocol) نوین و انقلابی در پروژه Xray است که برای عبور از سیستم‌های فیلترینگ، مانند GFW چین، و محدودیت‌های شبکه طراحی شده است. این پروتکل نتیجه تکاملی از SplitHTTP و سال‌ها تحقیق و توسعه است.

---

## 1. تاریخچه و توسعه

### مراحل تکاملی:

#### مرحله 1: SplitHTTP (میانسال 2024)
- توسعه‌دهندگان: @mmmray, @ll11l1lIllIl1lll
- **اول‌بار اجرا**: عبور از اکثر دستگاه‌های میانی HTTP بدون کاهش سرعت دانلود
- **دستاورد بزرگ**: اول‌بار پیاده‌سازی مقیاس‌گسترده‌ی QUIC H3 از طریق CDN

#### مرحله 2: اضافه شدن ویژگی‌های جدید
- **Browser Dialer**: انتقال مرورگر وب
- **Header Padding**: کاهش سیگنال‌های قابل شناسایی
- **XMUX**: کنترل پیشرفته مولتی‌پلکسینگ
- **REALITY Integration**: یکپارچگی با پروتکل REALITY

#### مرحله 3: XHTTP نهایی (زیر سرپرستی @RPRX)
- **اول‌بار**: جداسازی واقعی جریان‌های ورودی و خروجی
- **مثال**: بالا می‌تواند IPv6 CDN H3، پایین می‌تواند IPv4 REALITY H2 باشد
- **Stream-Up Mode**: جریان دوطرفه بدون افت کارایی
- **Extra Scheme**: اشتراک‌گذاری کامل پیکربندی

---

## 2. اصول و منطق طراحی

### 2.1 نظریه "آسیب جانبی"

**ایده اصلی:**
سیستم‌های فیلتر نمی‌توانند بدون مسدود کردن سرویس‌های معمول و مشروع، XHTTP را مسدود کنند.

**روش:**
- پنهان کردن XHTTP در میان ترافیک معمول (CDN، وب‌سایت‌های قانونی)
- افزایش هزینه فنی و سیاسی فیلتر‌کننده‌ها
- ایجاد uncertainty برای سیستم‌های فیلتر

**مثال عملی:**
GFW نمی‌تواند IP کامل Cloudflare را مسدود کند، زیرا میلیون‌ها سایت معمول روی آن کار می‌کنند.

### 2.2 استفاده از ویژگی‌های Streaming HTTP

**مشکل**: CDN و دستگاه‌های میانی درخواست‌های HTTP را کش می‌کنند
**حل**: استفاده از Streaming بدون بافرکردن کامل

**مقایسه با Meek (Tor):**
| معیار | Meek | XHTTP |
|-------|------|-------|
| بسته‌بندی | درخواست HTTP تکی | Streaming |
| سرعت دانلود | بسیار کند | تا حداکثر |

---

## 3. حالات عملیاتی (Modes)

### 3.1 Packet-Up: حداکثر سازگاری

**معماری:**
1. **بالای جریان** (Upload):
   ```
   POST /yourpath/{uuid}/{seq}
   ```
   - UUID: شناسه تصادفی برای رابط‌سازی
   - seq: شماره‌ی دنباله‌ای (از 0 شروع)
   - مهلت رابط‌سازی: 30 ثانیه
   - ویژگی اصلی: seq خودکار بدون انتظار برای پاسخ

2. **پایین جریان** (Download):
   ```
   GET /yourpath/{uuid}
   ```

3. **Header Padding (نقش حیاتی)**:
   - درخواست کلاینت: `Referer: ...?x_padding=XXX...` (100-1000 بایت تصادفی)
   - پاسخ سرور: `X-Padding: XXX...` (100-1000 بایت تصادفی)
   - هدف: پنهان کردن ویژگی‌های طول ثابت

4. **محدودیت‌های POST**:
   - `scMaxEachPostBytes`: 1MB (پیش‌فرض)
   - `scMinPostsIntervalMs`: 30ms (پیش‌فرض)
   - `scMaxBufferedPosts`: 30 (پیش‌فرض)

### 3.2 Stream-Up: جریان دوطرفه

**ویژگی‌ها:**
```
POST /yourpath/{uuid}
```
- جریان پیوسته برای بالا و پایین
- `Content-Type: application/grpc` (ریختار gRPC)
- بهتری از Stream-One

**مزایا نسبت به gRPC سنتی:**
- عدم نیاز به کتابخانه gRPC (کارایی بالاتر)
- جریان پایین مستقل (بدون محدودیت CDN)
- ویژگی‌های اضافی (Padding، XMUX، Split)

**مسئله Cloudflare:**
- CF پس از 100 ثانیه بی‌کاری اتصال را می‌خورد
- حل: `scStreamUpServerSecs` (پیش‌فرض: "20-80" ثانیه)

### 3.3 Stream-One: ساده‌ترین

```
POST /yourpath/
```
- جریان دوطرفه ساده
- تمام درخواست و پاسخ دارای Header Padding
- سازگاری کمتر

---

## 4. پشتیبانی HTTP Versions (H1/H2/H3)

### نقطه‌ی کلیدی: تبدیل نسخه توسط CDN

**اهمیت:**
CDN و Nginx خودکار H3 را به H1/H2 تبدیل می‌کنند

**نتیجه:**
- سرور می‌تواند فقط H1/H2 شنود کند
- کلاینت می‌تواند H3 استفاده کند!

### تنظیمات کلاینت:

| شرط | نسخه استفاده‌شده |
|-----|---|
| TLS + REALITY | H2 (پیش‌فرض) |
| بدون TLS | HTTP/1.1 |
| `alpn: ["h3"]` | quic-go H3 |
| Browser Dialer | توسط مرورگر تعیین می‌شود |

### QUIC H3 از طریق CDN:

**اول‌بار:**
- اول‌بار پیاده‌سازی مقیاس‌گسترده بدون سیگنال H3 خارجی
- برخی مناطق: H3 به‌خوبی کار می‌کند
- برخی: H3 کاملاً مسدود می‌شود

---

## 5. XMUX: کنترل مولتی‌پلکسینگ

### مشکل:
H2 و H3 مولتی‌پلکس می‌شوند، اما سیگنال pattern ثابت می‌توانند قابل شناسایی باشند.

### راه‌حل: XMUX

| پارامتر | پیش‌فرض | توضیح |
|---------|---|---------|
| `maxConcurrency` | "16-32" | حداکثر درخواست همزمان در اتصال |
| `maxConnections` | 0 | حداکثر اتصالات (0 = نامحدود) |
| `cMaxReuseTimes` | 0 | حداکثر استفاده از اتصال (0 = نامحدود) |
| `hMaxRequestTimes` | "600-900" | حداکثر درخواست HTTP (Nginx limit) |
| `hMaxReusableSecs` | "1800-3000" | حداکثر مدت زمان (Nginx 1h limit) |
| `hKeepAlivePeriod` | 0 | فاصله Keep-Alive |

### اصول طراحی:
- استفاده از range برای تصادفی‌سازی
- هر بار مقدار متفاوت برای کاهش pattern
- درهم‌زدن محدودیت‌های Nginx برای پنهان‌سازی

---

## 6. جداسازی جریان‌های ورودی/خروجی

### نظریه:
GFW شناسایی براساس یک اتصال کار می‌کند. حل: تقسیم جریان‌ها

### پیاده‌سازی:

```json
"downloadSettings": {
  "address": "another-domain.com",
  "port": 443,
  "network": "xhttp",
  "security": "tls",
  "xhttpSettings": {
    "path": "/yourpath"  // باید یکسان باشد
  }
}
```

### استراتژی‌های عملی:

1. **CDN بدون تغییر سرور:**
   - IPv4 + TLS + H2 (بالا)
   - IPv6 + QUIC + H3 (پایین)

2. **با دومینیوم‌های مختلف:**
   - بالا: `a.example.com`
   - پایین: `b.example.com`
   - Host: `c.example.com`

3. **REALITY بدون دومینیوم:**
   - دو VPS مختلف
   - Path یکسان

---

## 7. پارامترهای پیشرفته (Extra Scheme)

### Extra Mechanism:
تمام پارامترهای پیشرفته در `extra` ذخیره می‌شوند.

**پارامترهای اصلی** (همیشه موثر):
- `host`
- `path`
- `mode`

**وقتی `extra` وجود دارد**: فقط این چهار موثر‌اند

### مثال پیکربندی کامل:

```json
{
  "host": "example.com",
  "path": "/yourpath",
  "mode": "auto",
  "extra": {
    "xPaddingBytes": "100-1000",
    "noGRPCHeader": false,
    "noSSEHeader": false,
    "scMaxEachPostBytes": 1000000,
    "scMinPostsIntervalMs": 30,
    "scMaxBufferedPosts": 30,
    "scStreamUpServerSecs": "20-80",
    "xmux": {
      "maxConcurrency": "16-32",
      "maxConnections": 0,
      "cMaxReuseTimes": 0,
      "hMaxRequestTimes": "600-900",
      "hMaxReusableSecs": "1800-3000",
      "hKeepAlivePeriod": 0
    },
    "downloadSettings": {
      "address": "",
      "port": 443,
      "network": "xhttp",
      "security": "tls"
    }
  }
}
```

---

## 8. راهنمای سریع راه‌اندازی

### 6 مرحله‌ی اساسی:

1. **تنظیم پایه:**
   ```
   path: /yourpath
   ```
   (بقیه موارد پیش‌فرض)

2. **استفاده از H3:**
   ```
   alpn: "h3"
   ```
   (اگر سرور پشتیبان باشد)

3. **بهینه‌سازی CDN:**
   ```
   address: "selected-ip"
   serverName: "domain.com"
   ```

4. **Cloudflare:**
   - فعال کردن gRPC Support در پنل

5. **Nginx:**
   ```nginx
   grpc_pass grpc://backend;
   ```

6. **دیگر CDNها:**
   ```
   mode: "packet-up"
   ```
   (بیشترین سازگاری)

---

## 9. محدودیت‌ها و حل‌های معروف

| مسئله | علت | حل |
|------|-----|-----|
| **Cloudflare Timeout** | 100s بی‌کاری | Keep-Alive (scStreamUpServerSecs) |
| **تست سرعت کند** | Multiplexing | `maxConcurrency: 1` |
| **Nginx قطع** | proxy_pass نه grpc_pass | تغییر به `grpc_pass` |
| **Cross-Domain Error** | CORS | Header Padding خودکار |
| **CDN محدودیت Stream** | نیست Streaming Support | تبدیل به `packet-up` |
| **SSH Disconnect** | بدون Keep-Alive برنامه | `ClientAliveInterval` در sshd |

---

## 10. مقایسه با سایر Transports

| ویژگی | XHTTP | WebSocket | gRPC | HTTP |
|-------|-------|-----------|------|------|
| **عبور CDN** | ✓ | ✓ | ✓ | ✓ |
| **QUIC H3** | ✓ | ✗ | ✗ | ✗ |
| **Header Padding** | ✓ | ✗ | ✗ | ✗ |
| **XMUX** | ✓ | ✗ | ✗ | ✗ |
| **Split Streams** | ✓ | ✗ | ✗ | ✗ |
| **سرعت** | خوب | متوسط | متوسط | پایین |
| **Stealth** | بالا | متوسط | پایین | خیلی پایین |

---

## 11. نکات فلسفی و اجتماعی

### بحث "سوء استفاده از CDN"

**نقطه نظر توسعه‌دهندگان:**
- عادلانه‌بودن: برای مقابله با GFW
- نه نادرستی بلکه ضرورت
- قوانین مختلف در حوزه anti-censorship

**آنالوژی:**
اگر CDN IP درون whitelist قرار گیرد، آیا استفاده کنید؟ بله، زیرا محدودیت‌های معمول نقش نمی‌ایفاید.

---

## 12. نتیجه‌گیری: "Beyond REALITY"

### معنی:
نه جایگزین‌کردن REALITY، بلکه رسیدن به محبوبیت بیشتر.

### دلایل:
1. **پوشش گسترده:** CDN، REALITY، ترکیب‌ها
2. **انعطاف‌پذیری:** سه حالت مختلف
3. **تکامل:** Padding، XMUX، Split
4. **فلسفه Xray:** تغییر و نوآوری

### فلسفه نهایی:
> "تغییر و نوآوری، همیشه ایمان Xray است"

---

## منابع

- صفحه اصلی: XHTTP: Beyond REALITY - GitHub Discussion
- پروژه: XTLS/Xray-core
- توسعه‌دهندگان اصلی: @RPRX, @mmmray, @ll11l1lIllIl1lll

---

**نسخه:** 1.0
**تاریخ:** دسامبر 2024
**زبان:** فارسی

